<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Cards | SafeCard</title>
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div class="page">
      <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
      <h1 class="page-title">Search &amp; View Cards</h1>
      <p class="page-subtitle">
        Find cardholder records by last 4 digits or browse all cards.
      </p>

      <section class="card">
        <div class="card-header">
          <div class="card-header-icon"></div>
          <div>
            <h2>Search by Last 4 Digits</h2>
            <p>Enter the last 4 digits of the card number to search.</p>
          </div>
        </div>

        <form id="searchForm" class="form-grid">
          <div>
            <label for="last4">Last 4 Digits</label>
            <input
              type="text"
              id="last4"
              maxlength="4"
              inputmode="numeric"
              placeholder="1234"
              required
            />
          </div>
          <div class="search-actions">
            <button type="submit" class="action-button primary">
               Search
            </button>
            <button
              type="button"
              id="showAll"
              class="action-button secondary"
            >
               Show All
            </button>
          </div>
          <div id="searchMessage" class="message"></div>
        </form>
      </section>

      <section class="table-card">
        <div class="table-header">
          <div>
            <div class="section-title" style="margin-bottom: 4px">
              All Card Records
            </div>
            <div class="section-subtitle" id="resultsSubtitle">
              Showing 0 cards
            </div>
          </div>
          <div class="badge" id="recordsCount">0 Records</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Cardholder Name</th>
              <th>Masked PAN</th>
              <th>Created Time</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr>
              <td colspan="3" class="table-empty">
                Use the search form to load card records.
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </div>

    <script src="assets/app.js"></script>
    <script>
      const form = document.getElementById("searchForm");
      const last4Input = document.getElementById("last4");
      const showAllBtn = document.getElementById("showAll");
      const resultsBody = document.getElementById("resultsBody");
      const recordsCount = document.getElementById("recordsCount");
      const resultsSubtitle = document.getElementById("resultsSubtitle");
      const messageEl = document.getElementById("searchMessage");

      function renderResults(cards, filterLabel = "") {
        resultsBody.innerHTML = "";

        if (!cards || cards.length === 0) {
          resultsBody.innerHTML = `
            <tr>
              <td colspan="3" class="table-empty">
                No matching cards were found.
              </td>
            </tr>
          `;
          recordsCount.textContent = "0 Records";
          resultsSubtitle.textContent = filterLabel
            ? `No cards match "${filterLabel}"`
            : "Showing 0 cards";
          return;
        }

        cards.forEach((card) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="record-meta">
                <div class="record-icon"></div>
                <div>
                  <div style="font-weight:600;">
                    ${card.cardholderName || "Unknown"}
                  </div>
                  <div class="muted">${
                    card.referenceId ? `Ref: ${card.referenceId}` : ""
                  }</div>
                </div>
              </div>
            </td>
            <td>${CardUi.formatMaskedPan(card)}</td>
            <td>${CardUi.formatTimestamp(
              card.createdAt || card.createdTime || card.createdDate
            )}</td>
          `;
          resultsBody.appendChild(row);
        });

        recordsCount.textContent = `${cards.length} ${
          cards.length === 1 ? "Record" : "Records"
        }`;
        resultsSubtitle.textContent = filterLabel
          ? `Filtered by ${filterLabel}`
          : `Showing ${cards.length} cards`;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        CardUi.clearMessage(messageEl);

        const input = last4Input.value.trim();

        if (input.length !== 4 || /\D/.test(input)) {
          CardUi.showMessage(
            messageEl,
            "Enter exactly four digits to search.",
            "error"
          );
          return;
        }

        try {
          const data = await CardApi.listCards({ last4: input });
          const cards = Array.isArray(data) ? data : data.content || [];
          renderResults(cards, `last 4 digits = ${input}`);
        } catch (error) {
          CardUi.showMessage(messageEl, error.message, "error");
        }
      });

      showAllBtn.addEventListener("click", async () => {
        CardUi.clearMessage(messageEl);
        try {
          const data = await CardApi.listCards();
          const cards = Array.isArray(data) ? data : data.content || [];
          renderResults(cards, "all cards");
        } catch (error) {
          CardUi.showMessage(messageEl, error.message, "error");
        }
      });
    </script>
  </body>
</html>
